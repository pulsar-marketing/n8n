# Multi-stage Build für n8n 2.x mit zusätzlichen Tools
# https://github.com/n8n-io/n8n/tags

# Stage 1: Base Alpine mit Node.js
FROM node:22-alpine3.20 AS base

# Root User für Installation
USER root

# System-Pakete installieren
RUN apk add --no-cache \
    python3 \
    py3-pip \
    build-base \
    cairo-dev \
    jpeg-dev \
    pango-dev \
    giflib-dev \
    pixman-dev \
    pangomm-dev \
    libjpeg-turbo-dev \
    freetype-dev \
    git \
    graphicsmagick \
    curl \
    sshpass \
    openssh-client \
    tini \
    tzdata

# n8n global installieren (immer neueste Version)
RUN npm install -g n8n

# Cloudflared installieren
RUN curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o /usr/local/bin/cloudflared && \
    chmod +x /usr/local/bin/cloudflared

# n8n User erstellen
RUN addgroup -g 1000 node || true && \
    adduser -u 1000 -G node -s /bin/sh -D node 2>/dev/null || true

# Arbeitsverzeichnis
WORKDIR /home/node

# Zu node User wechseln
USER node

# n8n Datenverzeichnis
RUN mkdir -p /home/node/.n8n

# Expose ports
EXPOSE 5678

# Entrypoint
ENTRYPOINT ["tini", "--", "n8n"]